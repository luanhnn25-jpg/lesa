<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acesso Premium ‚Ä¢ LPP</title>

  <style>
    :root{
      --bg1:#0b3d91; --bg2:#0a2f73;
      --card:#ffffff; --text:#0f172a; --muted:#475569;
      --border:rgba(15,23,42,.12);
      --shadow:0 18px 45px rgba(2,6,23,.18);
      --shadow2:0 12px 30px rgba(2,6,23,.12);
      --radius:18px;
      --primary:#2563eb; --primary2:#1d4ed8;
      --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;
      --field:#f8fafc; --focus:rgba(37,99,235,.22);
      --chip:#eef2ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 520px at 15% 5%, rgba(255,255,255,.14), transparent 55%),
        radial-gradient(900px 520px at 85% 15%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    .wrap{
      width:min(1040px, 100%);
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 920px){
      .wrap{grid-template-columns:1fr}
    }

    .hero{
      border:1px solid rgba(255,255,255,.18);
      border-radius:var(--radius);
      padding:20px;
      background:rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 55px rgba(0,0,0,.18);
      color:#fff;
      position:relative;
      overflow:hidden;
      min-height: 340px;
    }
    .hero::after{
      content:"";
      position:absolute;
      inset:-90px -140px auto auto;
      width:380px;height:380px;
      background: radial-gradient(circle at 30% 30%, rgba(37,99,235,.55), transparent 60%);
      transform: rotate(18deg);
      pointer-events:none;
      opacity:.9;
    }
    .brand{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:12px;
    }
    .logo{
      width:46px;height:46px;border-radius:16px;
      background:rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.20);
      display:grid;place-items:center;
      font-weight:950;letter-spacing:.6px;
    }
    .brand h1{margin:0;font-size:18px;font-weight:950}
    .brand p{margin:2px 0 0;font-size:12px;opacity:.92}

    .hero h2{
      margin:10px 0 8px;
      font-size:clamp(22px, 3.2vw, 32px);
      font-weight:1000;
      letter-spacing:.2px;
    }
    .hero .sub{
      margin:0;
      opacity:.92;
      line-height:1.55;
      max-width:56ch;
      font-size:14px;
    }

    .bullets{
      margin:14px 0 0;
      padding:0;
      list-style:none;
      display:grid;
      gap:10px;
    }
    .bullets li{
      display:flex;
      gap:10px;
      align-items:flex-start;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      padding:10px 12px;
      border-radius:14px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:rgba(255,255,255,.85);
      margin-top:6px;flex:0 0 auto;
    }
    .bullets b{font-weight:950}
    .bullets span{opacity:.92;font-size:13px;line-height:1.45}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      overflow:hidden;
    }

    .topBadge{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f8fafc;
      font-weight:950;
      font-size:12px;
      color:var(--muted);
    }

    .pay{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:linear-gradient(180deg, #ffffff, #f7fbff);
      box-shadow: var(--shadow2);
    }
    .pay h3{margin:0 0 6px;font-size:16px;font-weight:1000}
    .price{
      font-size:30px;
      font-weight:1000;
      margin:2px 0 10px;
      color:#0b3d91;
      letter-spacing:.2px;
    }
    .chips{margin:6px 0 0}
    .chip{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid rgba(37,99,235,.18);
      color:#1e40af;
      font-weight:950;
      font-size:12px;
      margin:6px 6px 0 0;
    }
    .hint{
      margin:8px 0 10px;
      font-size:13px;
      color:var(--muted);
      line-height:1.5;
    }
    textarea{
      width:100%;
      min-height:74px;
      border-radius:14px;
      border:1px solid var(--border);
      padding:10px;
      resize:none;
      outline:none;
      background:#fff;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      font-size:13px;
      color:#0f172a;
    }
    textarea:focus{box-shadow:0 0 0 4px var(--focus)}

    .btn{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(37,99,235,.35);
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      color:#fff;
      font-weight:1000;
      cursor:pointer;
      margin-top:10px;
      transition: transform .05s ease, filter .15s ease;
    }
    .btn:hover{filter:brightness(1.03)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{
      background:#fff;
      color:#1d4ed8;
      border-color: rgba(37,99,235,.25);
    }
    .btn.whats{
      background: linear-gradient(180deg, #22c55e, #16a34a);
      border-color: rgba(22,163,74,.35);
    }

    .card h4{
      margin:14px 0 6px;
      font-size:16px;
      font-weight:1000;
      letter-spacing:.2px;
    }

    .tabs{
      display:flex;
      gap:8px;
      margin:10px 0 12px;
    }
    .tab{
      flex:1;
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:950;
      font-size:13px;
      color:var(--muted);
    }
    .tab[aria-selected="true"]{
      border-color: rgba(37,99,235,.35);
      background: rgba(37,99,235,.08);
      color: #1d4ed8;
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:10px 0 6px;
      font-weight:900;
    }
    .fieldWrap{position:relative}
    .field{
      width:100%;
      padding:12px 44px 12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--field);
      outline:none;
      font-size:14px;
      transition: box-shadow .15s, border-color .15s;
    }
    .field:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 5px var(--focus);
      background:#fff;
    }
    .togglePwd{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      border:none;
      background:transparent;
      cursor:pointer;
      width:34px;height:34px;
      border-radius:10px;
      display:grid;place-items:center;
      color:#1d4ed8;
      font-weight:1000;
    }
    .togglePwd:focus-visible{
      outline:none;
      box-shadow: 0 0 0 4px var(--focus);
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .small{
      font-size:12px;
      color:var(--muted);
      margin:0;
    }
    .link{
      border:none;
      background:none;
      padding:0;
      cursor:pointer;
      color:#1d4ed8;
      font-weight:1000;
      font-size:12px;
      text-decoration:underline;
    }

    .msg{
      margin:12px 0 0;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--muted);
      font-size:13px;
      white-space:pre-wrap;
      display:none;
    }
    .msg.show{display:block}
    .msg.ok{border-color:rgba(22,163,74,.30); background:rgba(22,163,74,.08); color:#14532d}
    .msg.warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); color:#7c2d12}
    .msg.bad{border-color:rgba(220,38,38,.30); background:rgba(220,38,38,.08); color:#7f1d1d}

    .footer{
      margin-top:12px;
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Lado esquerdo -->
    <section class="hero" aria-label="Informa√ß√µes Premium">
      <div class="brand">
        <div class="logo">LPP</div>
        <div>
          <h1>Les√£o por Press√£o</h1>
          <p>Conte√∫do premium (acesso pago)</p>
        </div>
      </div>

      <h2>Premium por R$ 2,00 (Pix)</h2>
      <p class="sub">
        Ap√≥s o pagamento, envie o comprovante no WhatsApp para libera√ß√£o do seu perfil (<b>premium=true</b>).
        Depois, fa√ßa login e o sistema libera automaticamente a <b>Sele√ß√£o de Produtos</b>.
      </p>

      <ul class="bullets">
        <li><span class="dot"></span><span><b>Pix</b> (pagamento r√°pido)</span></li>
        <li><span class="dot"></span><span><b>Confirma√ß√£o por WhatsApp</b> (comprovante)</span></li>
        <li><span class="dot"></span><span><b>Libera√ß√£o</b> via perfil no Supabase</span></li>
      </ul>
    </section>

    <!-- Lado direito -->
    <main class="card" aria-label="Pagamento e Acesso">
      <div class="topBadge">
        <span class="pill">‚≠ê Acesso Premium</span>
        <span class="pill">Pix ‚Ä¢ R$ 2,00</span>
      </div>

      <!-- PAGAMENTO (sempre vis√≠vel antes do login) -->
      <section class="pay" aria-label="Pagamento via Pix">
        <h3>Pagamento via Pix</h3>
        <div class="price">R$ 2,00</div>

        <div class="chips">
          <span class="chip">Pix apenas</span>
          <span class="chip">Libera Sele√ß√£o de Produtos</span>
          <span class="chip">Confirma√ß√£o WhatsApp</span>
        </div>

        <p class="hint">
          1) Copie a chave Pix e pague no seu banco.<br/>
          2) Toque em <b>Enviar comprovante</b> e mande no WhatsApp.<br/>
          3) Fa√ßa login para o sistema verificar seu acesso.
        </p>

        <textarea id="pixKey" readonly>28d39758-0fe0-47f1-9c7c-9cb6e032c5cf</textarea>

        <button id="btnCopyPix" class="btn" type="button">üìã Copiar Pix</button>
        <button id="btnOpenPremium" class="btn secondary" type="button">‚≠ê Ver p√°gina Premium</button>
        <button id="btnWhats" class="btn whats" type="button">üí¨ Enviar comprovante no WhatsApp</button>
      </section>

      <h4>Entrar</h4>
      <p class="hint" style="margin-top:0">
        Fa√ßa login. Se voc√™ <b>n√£o</b> tiver Premium, voc√™ ser√° direcionado(a) para a p√°gina inicial.
      </p>

      <div class="tabs" role="tablist" aria-label="Alternar modo">
        <button class="tab" id="tabLogin" role="tab" aria-selected="true" type="button">Login</button>
        <button class="tab" id="tabSignup" role="tab" aria-selected="false" type="button">Criar conta</button>
      </div>

      <label for="email">Email</label>
      <input id="email" class="field" type="email" placeholder="seuemail@exemplo.com" autocomplete="email" />

      <label for="password">Senha</label>
      <div class="fieldWrap">
        <input id="password" class="field" type="password" placeholder="m√≠n. 6 caracteres" autocomplete="current-password" />
        <button id="btnTogglePwd" class="togglePwd" type="button" aria-label="Mostrar senha">üëÅÔ∏è</button>
      </div>

      <div class="row">
        <p class="small" id="modeHint">Modo: Login</p>
        <button class="link" id="btnForgot" type="button">Esqueci minha senha</button>
      </div>

      <button class="btn" id="btnPrimary" type="button">Entrar</button>
      <button class="btn secondary" id="btnGoHome" type="button">Voltar ao site</button>

      <div class="msg" id="msg" role="status" aria-live="polite"></div>

      <div class="footer">¬© 2026 ‚Ä¢ Projeto Integrador</div>
    </main>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ===================== CONFIG =====================
    const SUPABASE_URL = "https://owpswekkfaleauwjmahc.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_I58BBfTZcWtPEIIDSuN5MA_sV8jfPfq";

    const SITE_BASE = "https://luanhnn25-jpg.github.io/lesa/";
    const EMAIL_REDIRECT_TO = SITE_BASE + "login.html";

    // Rotas p√≥s login:
    const AFTER_LOGIN_PREMIUM = SITE_BASE + "selecao-produtos.html";
    const AFTER_LOGIN_NOT_PREMIUM = SITE_BASE + "index.html";

    // P√°gina premium (onde voc√™ explica/mostra pagamento)
    const PREMIUM_PAGE = SITE_BASE + "premium.html";

    // WhatsApp (n√∫mero informado por voc√™)
    const WHATS_NUMBER = "5515988119989"; // +55 15 98811-9989
    // ==================================================

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const el = (id) => document.getElementById(id);
    const msgBox = el("msg");

    function setMsg(text, type="warn"){
      msgBox.textContent = text;
      msgBox.className = "msg show " + (type || "warn");
    }
    function clearMsg(){
      msgBox.textContent = "";
      msgBox.className = "msg";
    }

    // ----------- Pix / Whats ----------
    async function copyPix(){
      const val = el("pixKey").value.trim();
      try{
        await navigator.clipboard.writeText(val);
        setMsg("Pix copiado ‚úÖ\nCole no app do banco e pague R$ 2,00.\nDepois envie o comprovante no WhatsApp.", "ok");
      }catch{
        setMsg("N√£o foi poss√≠vel copiar automaticamente.\nSelecione o Pix e copie manualmente.", "warn");
      }
    }

    function openWhats(){
      const email = el("email").value.trim() || "(meu email)";
      const txt =
`Ol√°! Paguei o Premium LPP (R$ 2,00 via Pix).
Email: ${email}

Estou enviando o comprovante. Pode liberar meu acesso (premium=true)?`;
      const url = "https://wa.me/" + WHATS_NUMBER + "?text=" + encodeURIComponent(txt);
      window.open(url, "_blank");
    }

    el("btnCopyPix").addEventListener("click", copyPix);
    el("btnWhats").addEventListener("click", openWhats);
    el("btnOpenPremium").addEventListener("click", () => window.location.href = PREMIUM_PAGE);

    // ----------- Mostrar senha ----------
    el("btnTogglePwd").addEventListener("click", () => {
      const inp = el("password");
      const isPwd = inp.type === "password";
      inp.type = isPwd ? "text" : "password";
      el("btnTogglePwd").textContent = isPwd ? "üôà" : "üëÅÔ∏è";
      el("btnTogglePwd").setAttribute("aria-label", isPwd ? "Ocultar senha" : "Mostrar senha");
    });

    // ----------- Tabs login / signup ----------
    let mode = "login"; // "login" | "signup"
    const tabLogin = el("tabLogin");
    const tabSignup = el("tabSignup");
    const btnPrimary = el("btnPrimary");
    const modeHint = el("modeHint");

    function setMode(next){
      mode = next;
      clearMsg();
      const isLogin = mode === "login";
      tabLogin.setAttribute("aria-selected", String(isLogin));
      tabSignup.setAttribute("aria-selected", String(!isLogin));
      el("password").setAttribute("autocomplete", isLogin ? "current-password" : "new-password");
      modeHint.textContent = "Modo: " + (isLogin ? "Login" : "Criar conta");
      btnPrimary.textContent = isLogin ? "Entrar" : "Criar conta";
    }
    tabLogin.addEventListener("click", () => setMode("login"));
    tabSignup.addEventListener("click", () => setMode("signup"));

    // Permite abrir j√° na aba pelo par√¢metro ?mode=signup
    const params = new URLSearchParams(location.search);
    if (params.get("mode") === "signup") setMode("signup");
    else setMode("login");

    el("btnGoHome").addEventListener("click", () => window.location.href = SITE_BASE + "index.html");

    // ----------- Anti-spam / cooldown (resolve erro ‚Äúafter 4 seconds‚Äù) ----------
    let busy = false;
    let cooldownUntil = 0;

    function canRun(){
      const now = Date.now();
      if (busy) return false;
      if (now < cooldownUntil) return false;
      return true;
    }
    function startCooldown(ms){
      cooldownUntil = Date.now() + ms;
    }
    function setBusy(v){
      busy = v;
      btnPrimary.disabled = v;
      btnPrimary.style.opacity = v ? ".75" : "1";
      btnPrimary.style.cursor = v ? "not-allowed" : "pointer";
    }

    // ----------- Verifica√ß√£o premium (sem loop infinito) ----------
    async function fetchPremium(uid){
      // timeout simples
      const timeoutMs = 8000;
      const timeout = new Promise((_, rej) => setTimeout(() => rej(new Error("timeout")), timeoutMs));

      const query = supabase
        .from("profiles")
        .select("premium")
        .eq("id", uid)
        .single();

      const res = await Promise.race([query, timeout]);
      return res; // { data, error }
    }

    async function checkAndRedirectAfterLogin(){
      setMsg("Login realizado. Verificando Premium‚Ä¶", "warn");

      const { data: userRes, error: userErr } = await supabase.auth.getUser();
      if (userErr || !userRes?.user){
        setMsg("Falha ao confirmar sess√£o. Indo para in√≠cio‚Ä¶", "bad");
        setTimeout(() => window.location.href = AFTER_LOGIN_NOT_PREMIUM, 900);
        return;
      }

      const uid = userRes.user.id;

      try{
        const { data, error } = await fetchPremium(uid);

        if (error){
          // Se n√£o existir linha no profiles, trate como n√£o premium (evita ‚Äúinfinito‚Äù)
          setMsg(
            "N√£o foi poss√≠vel validar o Premium agora.\n" +
            "Voc√™ ser√° direcionado(a) para a p√°gina inicial.\n\n" +
            "Detalhe: " + error.message,
            "warn"
          );
          setTimeout(() => window.location.href = AFTER_LOGIN_NOT_PREMIUM, 1300);
          return;
        }

        if (data?.premium){
          setMsg("Premium ‚úÖ Acesso liberado. Redirecionando‚Ä¶", "ok");
          setTimeout(() => window.location.href = AFTER_LOGIN_PREMIUM, 700);
        }else{
          setMsg("Voc√™ n√£o tem Premium. Indo para a p√°gina inicial‚Ä¶", "warn");
          setTimeout(() => window.location.href = AFTER_LOGIN_NOT_PREMIUM, 900);
        }
      }catch(e){
        setMsg("Tempo de resposta excedido ao validar Premium.\nIndo para a p√°gina inicial‚Ä¶", "warn");
        setTimeout(() => window.location.href = AFTER_LOGIN_NOT_PREMIUM, 1200);
      }
    }

    // ----------- Login / Signup ----------
    async function handleLogin(email, password){
      setMsg("Entrando‚Ä¶", "warn");
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return setMsg("Erro no login:\n" + error.message, "bad");
      await checkAndRedirectAfterLogin();
    }

    async function handleSignup(email, password){
      setMsg("Criando conta‚Ä¶", "warn");

      const { error } = await supabase.auth.signUp({
        email,
        password,
        options: { emailRedirectTo: EMAIL_REDIRECT_TO }
      });

      if (error){
        // Rate limit comum: "only request this after 4 seconds"
        setMsg("Erro ao criar conta:\n" + error.message + "\n\nAguarde alguns segundos e tente novamente.", "bad");
        startCooldown(5000);
        return;
      }

      setMsg(
        "Conta criada!\n\n1) Verifique seu email (e spam).\n2) Clique no link de confirma√ß√£o.\n3) Depois volte e fa√ßa login.\n\nDica: ap√≥s pagar o Pix, envie o comprovante no WhatsApp para liberar o Premium.",
        "ok"
      );

      startCooldown(4000);
    }

    // ----------- Forgot password ----------
    el("btnForgot").addEventListener("click", async () => {
      if (busy) return;
      clearMsg();
      const email = el("email").value.trim();
      if (!email) return setMsg("Digite seu email para receber o link de recupera√ß√£o.", "bad");

      setBusy(true);
      try{
        setMsg("Enviando link de recupera√ß√£o‚Ä¶", "warn");
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: EMAIL_REDIRECT_TO });
        if (error) return setMsg("Erro ao enviar recupera√ß√£o:\n" + error.message, "bad");
        setMsg("Pronto! Enviamos um link de recupera√ß√£o para seu email.", "ok");
      }finally{
        setBusy(false);
      }
    });

    // ----------- Bot√£o principal ----------
    btnPrimary.addEventListener("click", async () => {
      if (!canRun()){
        const sec = Math.ceil((cooldownUntil - Date.now())/1000);
        if (sec > 0) setMsg("Aguarde " + sec + "s antes de tentar novamente.", "warn");
        return;
      }

      clearMsg();
      const email = el("email").value.trim();
      const password = el("password").value;

      if (!email) return setMsg("Informe um email v√°lido.", "bad");
      if (!password || password.length < 6) return setMsg("A senha deve ter pelo menos 6 caracteres.", "bad");

      setBusy(true);
      try{
        if (mode === "login") await handleLogin(email, password);
        else await handleSignup(email, password);
      }finally{
        setBusy(false);
      }
    });

    // Mensagem inicial
    setMsg("Pronto. Voc√™ pode pagar via Pix e/ou fazer login.", "warn");
  </script>
</body>
</html>
