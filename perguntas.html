<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b3d91" />
  <title>Perguntas • Fontes Oficiais + PubMed • LPP</title>

  <style>
    :root{
      --bg1:#0b3d91; --bg2:#0a2f73; --bg3:#0b5bd3;
      --page:#eef2f7; --card:#ffffff; --text:#0f172a;
      --muted:#475569; --muted2:#64748b;
      --border:rgba(15,23,42,.10);
      --shadow:0 12px 30px rgba(2,6,23,.10);
      --shadow2:0 18px 45px rgba(2,6,23,.14);
      --radius:18px;
      --primary:#2563eb; --primary2:#1d4ed8;
      --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;
      --ring:0 0 0 4px rgba(56,130,246,.18);
      --chip:#eef2ff;
      --glass:rgba(255,255,255,.10);
      --glassBorder:rgba(255,255,255,.18);
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(11,91,211,.15), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(11,61,145,.14), transparent 55%),
        var(--page);
    }

    /* ===== Top header ===== */
    .top{
      position:sticky; top:0; z-index:1000;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      color:#fff;
      box-shadow: 0 12px 24px rgba(2,6,23,.18);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .top-inner{
      max-width:1100px; margin:0 auto;
      padding: 12px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width: 220px; }
    .logo{
      width:40px;height:40px;border-radius:14px;
      display:grid; place-items:center;
      font-weight:1000; letter-spacing:.6px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 12px 22px rgba(2,6,23,.18);
    }
    .brand h1{ margin:0; font-size:14px; font-weight:950; letter-spacing:.2px; line-height:1.1; }
    .brand p{ margin:2px 0 0; font-size:12px; opacity:.92; line-height:1.2; }

    .nav{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      justify-content:center; overflow:hidden;
    }
    .nav a{
      color:#eaf2ff; text-decoration:none;
      font-weight:900; font-size:13px;
      padding:10px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
      transition: transform .14s ease, background .14s ease, box-shadow .14s ease;
      white-space:nowrap;
    }
    .nav a:hover{
      background: rgba(255,255,255,.16);
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(2,6,23,.20);
    }
    .nav a[aria-current="page"]{
      background: rgba(255,255,255,.22);
      border-color: rgba(255,255,255,.28);
      box-shadow: 0 10px 18px rgba(2,6,23,.22);
    }

    /* ===== User bubble ===== */
    .userbox{ position:relative; min-width: 230px; display:flex; justify-content:flex-end; }
    .userbtn{
      width:100%;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color:#fff; cursor:pointer;
      font-weight:950;
      box-shadow: 0 10px 18px rgba(2,6,23,.18);
      transition: transform .14s ease, background .14s ease;
      outline:none;
    }
    .userbtn:hover{ background: rgba(255,255,255,.16); transform: translateY(-1px); }
    .userbtn:focus-visible{ box-shadow: var(--ring), 0 10px 18px rgba(2,6,23,.18); }

    .userleft{ display:flex; align-items:center; gap:10px; min-width:0; }
    .avatar{
      width:28px;height:28px;border-radius:999px;
      background: rgba(255,255,255,.20);
      border:1px solid rgba(255,255,255,.24);
      display:grid; place-items:center;
      font-weight:1000; flex:0 0 auto;
    }
    .userinfo{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .userinfo .name{
      font-size:12px; opacity:.92; font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 180px;
    }
    .userinfo .state{
      font-size:11px; opacity:.86;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 180px;
    }
    .caret{ opacity:.9; }

    .backdrop{
      position:fixed; inset:0;
      background: rgba(2,6,23,.45);
      display:none;
      z-index: 1999;
    }
    .backdrop.open{ display:block; }

    .menu{
      position:absolute; top: calc(100% + 8px); right:0;
      width:min(340px, 92vw);
      background: #fff;
      border:1px solid rgba(15,23,42,.12);
      border-radius: 16px;
      box-shadow: 0 18px 45px rgba(2,6,23,.20);
      padding:10px;
      display:none;
      z-index: 2000;
    }
    .menu.open{ display:block; }
    .menu .item{
      width:100%; border:none; background:#fff; text-align:left;
      padding:10px 12px; border-radius:14px; cursor:pointer;
      font-weight:900; color:#0f172a;
      display:flex; align-items:center; justify-content:space-between;
    }
    .menu .item:hover{ background:#f1f5f9; }
    .menu .muted{ color:#475569; font-weight:800; font-size:12px; margin:4px 12px 10px; }

    .tag{
      display:inline-block; padding:6px 10px; border-radius:999px;
      background: rgba(37,99,235,.10);
      border:1px solid rgba(37,99,235,.20);
      color:#1e40af; font-size:12px; font-weight:1000;
    }
    .tag.ok{ background: rgba(22,163,74,.10); border-color: rgba(22,163,74,.18); color:#14532d; }
    .tag.bad{ background: rgba(220,38,38,.10); border-color: rgba(220,38,38,.18); color:#7f1d1d; }

    @media (max-width: 980px){
      .nav{ display:none; }
      .userbox{ min-width:auto; width: 100%; }
      .brand{ min-width:auto; }

      .menu{
        position:fixed;
        left: 12px;
        right: 12px;
        top: 74px;
        width: auto;
        max-height: calc(100vh - 90px);
        overflow:auto;
      }
    }

    /* ===== Layout ===== */
    .wrap{ max-width:1100px; margin: 18px auto 60px; padding: 0 14px; }
    .grid{ display:grid; grid-template-columns: 1.05fr .95fr; gap: 14px; align-items:start; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background: linear-gradient(180deg,#fff, #fbfdff);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      transition: box-shadow .18s ease, border-color .18s ease, transform .18s ease;
    }
    .card:hover{ box-shadow: var(--shadow2); border-color: rgba(11,91,211,.20); transform: translateY(-1px); }

    .title{
      margin:0 0 8px;
      font-size: 18px; font-weight: 1000;
      color:#0b2b63; letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }
    .title::before{
      content:""; width:4px; height:22px; border-radius:999px;
      background: var(--bg3);
      box-shadow: 0 10px 18px rgba(11,91,211,.25);
    }
    .lead{ margin:0; color: var(--muted); line-height:1.6; font-size:14.5px; }

    .msg{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      color: var(--muted);
      font-size: 13px;
      white-space: pre-wrap;
      display:none;
    }
    .msg.show{ display:block; }
    .msg.ok{ border-color: rgba(22,163,74,.30); background: rgba(22,163,74,.08); color:#14532d; }
    .msg.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); color:#7c2d12; }
    .msg.bad{ border-color: rgba(220,38,38,.30); background: rgba(220,38,38,.08); color:#7f1d1d; }

    label{ display:block; margin: 10px 0 6px; font-size:12px; font-weight:900; color: var(--muted); }
    .field{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      padding: 12px 12px;
      font-size: 15px;
      outline:none;
      transition: box-shadow .14s ease, border-color .14s ease;
    }
    .field:focus{ border-color: rgba(37,99,235,.45); box-shadow: var(--ring); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row .col{ flex:1 1 180px; }

    .btn{
      border:none; cursor:pointer;
      padding:12px 12px; border-radius:14px;
      font-weight:1000; letter-spacing:.2px;
      width:100%;
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      color:#fff;
      border:1px solid rgba(37,99,235,.28);
      transition: transform .06s ease, filter .15s ease, box-shadow .15s ease;
    }
    .btn:hover{ filter:brightness(1.03); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ background:#fff; color:#1d4ed8; border:1px solid rgba(37,99,235,.20); }
    .btn.ghost{ background: transparent; color: #0f172a; border:1px solid rgba(15,23,42,.14); }

    .toggle{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.10);
      background: #fff;
      margin-top:10px;
    }
    .toggle strong{ font-size:13px; color:#0b2b63; }
    .toggle span{ font-size:12px; color: var(--muted2); }

    .switch{
      width:44px; height:26px; border-radius:999px;
      background: rgba(15,23,42,.16);
      position:relative; cursor:pointer;
      border:1px solid rgba(15,23,42,.10);
      flex: 0 0 auto;
    }
    .switch::after{
      content:"";
      position:absolute; top:3px; left:3px;
      width:20px; height:20px; border-radius:999px;
      background:#fff;
      box-shadow: 0 10px 18px rgba(2,6,23,.20);
      transition: transform .18s ease;
    }
    .switch.on{ background: rgba(37,99,235,.55); border-color: rgba(37,99,235,.35); }
    .switch.on::after{ transform: translateX(18px); }

    .tabs{ display:flex; gap:8px; margin-top: 12px; flex-wrap: wrap; }
    .tab{
      flex: 1 1 160px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:1000;
      font-size: 13px;
      color: var(--muted);
    }
    .tab.active{
      border-color: rgba(37,99,235,.35);
      background: rgba(37,99,235,.08);
      color: #1d4ed8;
    }

    .panel{
      margin-top: 10px;
      border:1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      background:#fff;
      padding: 12px;
      box-shadow: 0 12px 22px rgba(2,6,23,.06);
    }

    .result{
      border:1px solid rgba(15,23,42,.10);
      border-radius: 14px;
      padding: 10px 12px;
      margin: 10px 0;
      background: linear-gradient(180deg, #fff, #fbfdff);
      box-shadow: 0 12px 20px rgba(2,6,23,.06);
    }
    .result h3{ margin:0 0 6px; font-size: 14px; color:#0b2b63; line-height:1.3; }
    .result p{ margin:0; color: var(--muted); font-size: 13px; line-height:1.5; }
    .result a{ color:#1d4ed8; font-weight:900; text-decoration:none; word-break: break-word; }
    .result a:hover{ text-decoration: underline; }

    .mini{
      font-size:12px; color: var(--muted2);
      margin-top:8px;
      display:flex; gap: 8px; flex-wrap: wrap; align-items:center;
    }
    .chip{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      background: var(--chip);
      border:1px solid rgba(37,99,235,.18);
      color:#1e40af;
      font-weight:1000;
      font-size:12px;
    }

    .skeleton{
      border-radius: 14px;
      background: linear-gradient(90deg, rgba(15,23,42,.06), rgba(15,23,42,.10), rgba(15,23,42,.06));
      background-size: 200% 100%;
      animation: shimmer 1.1s infinite linear;
      height: 14px;
      margin: 10px 0;
    }
    .skeleton.big{ height: 18px; }
    @keyframes shimmer{ 0%{ background-position: 0% 0; } 100%{ background-position: 200% 0; } }

    .pay{
      margin-top:12px;
      border:1px solid rgba(15,23,42,.12);
      border-radius: 16px;
      padding: 12px;
      background: linear-gradient(180deg, #ffffff, #f8fafc);
    }
    .pay h2{ margin:0 0 6px; font-size: 16px; font-weight: 1000; }
    .price{ font-size: 30px; font-weight: 1100; color:#0b3d91; margin: 2px 0 6px; }

    textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.12);
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      resize:none;
      min-height: 88px;
      outline:none;
      background:#fff;
    }
    textarea:focus{ box-shadow: var(--ring); }

    .foot{
      text-align:center;
      color:#64748b;
      font-size:12px;
      margin-top: 16px;
      padding: 10px;
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; }
      html{ scroll-behavior:auto; }
    }
  </style>
</head>

<body>
  <header class="top">
    <div class="top-inner">
      <div class="brand">
        <div class="logo">LPP</div>
        <div>
          <h1>Perguntas com Fontes Oficiais</h1>
          <p>gov.br • COREN-SP • OMS/OPAS • PubMed</p>
        </div>
      </div>

      <nav class="nav" aria-label="Menu">
        <a href="index.html">Início</a>
        <a href="selecao-produtos.html">Seleção de Produtos</a>
        <a href="premium.html">Premium</a>
        <a href="perguntas.html" aria-current="page">Perguntas</a>
      </nav>

      <div class="userbox">
        <button id="userBtn" class="userbtn" type="button" aria-haspopup="menu" aria-expanded="false">
          <div class="userleft">
            <div class="avatar" id="avatar">?</div>
            <div class="userinfo">
              <div class="name" id="userName">Visitante</div>
              <div class="state" id="userState">Checando…</div>
            </div>
          </div>
          <div class="caret">▾</div>
        </button>

        <div id="userMenu" class="menu" role="menu" aria-label="Menu do usuário">
          <div class="muted" id="userMeta">Acesso: visitante</div>

          <button class="item" id="goLogin" type="button" role="menuitem">
            Entrar / Criar conta <span class="tag">login</span>
          </button>

          <button class="item" id="goPremium" type="button" role="menuitem">
            Premium <span class="tag" id="tagPremium">—</span>
          </button>

          <button class="item" id="logoutBtn" type="button" role="menuitem">
            Sair <span class="tag bad">logout</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <div id="backdrop" class="backdrop" aria-hidden="true"></div>

  <main class="wrap">
    <div class="grid">
      <!-- Coluna esquerda -->
      <section class="card">
        <h2 class="title">Acesso Premium e pagamento</h2>
        <p class="lead">
          Esta funcionalidade é Premium. Antes do login, você já visualiza o valor e as instruções do Pix.
          Após o pagamento, envie o comprovante via WhatsApp para liberação do <code>premium=true</code>.
        </p>

        <div class="pay" id="payBox">
          <h2>Premium (R$ 2,00 via Pix)</h2>
          <div class="price">R$ 2,00</div>
          <div class="mini">
            <span class="chip">Pix</span>
            <span class="chip">Libera Perguntas + Seleção</span>
            <span class="chip">COREN-SP + gov.br + PubMed</span>
          </div>

          <p class="lead" style="margin-top:10px;">
            1) Copie o Pix abaixo e pague no app do banco.<br>
            2) Clique em <b>Enviar comprovante</b> e encaminhe no WhatsApp.
          </p>

          <textarea id="pixPayload" readonly>28d39758-0fe0-47f1-9c7c-9cb6e032c5cf
Referência: PREMIUM-LPP
Valor: 2,00</textarea>

          <div class="row" style="margin-top:10px;">
            <div class="col"><button class="btn" id="copyPix" type="button">Copiar Pix</button></div>
            <div class="col"><button class="btn secondary" id="sendWhatsapp" type="button">Enviar comprovante no WhatsApp</button></div>
          </div>

          <div id="statusMsg" class="msg"></div>
        </div>
      </section>

      <!-- Coluna direita -->
      <section class="card">
        <h2 class="title">Perguntar</h2>
        <p class="lead" id="appSubtitle">
          Para liberar, faça login e tenha Premium ativo.
        </p>

        <!-- Bloqueado -->
        <div id="lockedBox" style="display:none;">
          <div class="msg warn show">
            Área <b>Premium</b>. Faça login e tenha <code>premium=true</code> em <code>profiles</code>.
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="col"><button class="btn" id="btnLogin" type="button">Entrar / Criar conta</button></div>
            <div class="col"><button class="btn secondary" id="btnPremium" type="button">Ir para Premium</button></div>
            <div class="col"><button class="btn ghost" id="btnHome" type="button">Voltar ao início</button></div>
          </div>

          <div class="msg warn show" style="margin-top:10px;">
            <b>Opcional:</b> se você quiser, ao logar sem Premium ele pode voltar ao Início automaticamente.
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="col"><button class="btn ghost" id="btnForceHome" type="button">Ativar redirecionamento automático (sem Premium)</button></div>
          </div>
        </div>

        <!-- Liberado -->
        <div id="appBox" style="display:none;">
          <label for="question">Pergunta</label>
          <input id="question" class="field" type="text" placeholder="Ex.: Vacinação, curativos, protocolos COREN, etc." />

          <div class="row">
            <div class="col">
              <label for="years">Janela (anos)</label>
              <select id="years" class="field">
                <option value="3">Últimos 3 anos</option>
                <option value="5" selected>Últimos 5 anos</option>
                <option value="10">Últimos 10 anos</option>
                <option value="15">Últimos 15 anos</option>
              </select>
            </div>
            <div class="col">
              <label for="limit">Resultados</label>
              <select id="limit" class="field">
                <option value="4">4</option>
                <option value="6" selected>6</option>
                <option value="8">8</option>
                <option value="10">10</option>
              </select>
            </div>
          </div>

          <div class="toggle" style="margin-top:10px;">
            <div>
              <strong>Modo IA (síntese)</strong><br>
              <span>Ativa síntese no backend (se configurado).</span>
            </div>
            <div id="aiSwitch" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="col"><button class="btn" id="askBtn" type="button">Buscar</button></div>
            <div class="col"><button class="btn secondary" id="clearBtn" type="button">Limpar</button></div>
          </div>

          <div class="tabs" id="tabs" style="display:none;">
            <button class="tab active" data-tab="answer" type="button">Resposta</button>
            <button class="tab" data-tab="official" type="button">Fontes oficiais</button>
            <button class="tab" data-tab="pubmed" type="button">PubMed</button>
          </div>

          <div class="panel">
            <div id="loading" style="display:none;">
              <div class="skeleton big"></div>
              <div class="skeleton"></div>
              <div class="skeleton"></div>
              <div class="skeleton"></div>
              <div class="skeleton"></div>
            </div>

            <div id="answerBox" style="display:none;"></div>
            <div id="officialBox" style="display:none;"></div>
            <div id="pubmedBox" style="display:none;"></div>
          </div>

          <div class="row" id="refsRow" style="margin-top:10px; display:none;">
            <div class="col"><button class="btn ghost" id="copyRefs" type="button">Copiar referências</button></div>
            <div class="col"><button class="btn ghost" id="copyLinks" type="button">Copiar links</button></div>
          </div>

          <div class="msg" id="msg"></div>
        </div>

        <div class="foot">© 2026 • Projeto Integrador</div>
      </section>
    </div>
  </main>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // =========================
    // CONFIG
    // =========================
    const SITE_BASE = "https://luanhnn25-jpg.github.io/lesa/";
    const SUPABASE_URL = "https://owpswekkfaleauwjmahc.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_I58BBfTZcWtPEIIDSuN5MA_sV8jfPfq";

    // ✅ AGORA: Supabase Edge Function (base até /functions/v1)
    const ASK_API_BASE = "https://owpswekkfaleauwjmahc.supabase.co/functions/v1";

    // WhatsApp para comprovante:
    const WHATSAPP_PHONE = "5515988119989";
    const WHATSAPP_DEFAULT_TEXT = "Olá! Segue comprovante do Pix (Premium LPP). Meu e-mail de login é: ";

    // Redirecionar automaticamente ao início se logar sem premium?
    let AUTO_HOME_IF_NOT_PREMIUM = false;

    // =========================
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $ = (id) => document.getElementById(id);

    const userBtn = $("userBtn");
    const userMenu = $("userMenu");
    const backdrop = $("backdrop");
    const userName = $("userName");
    const userState = $("userState");
    const avatar = $("avatar");
    const userMeta = $("userMeta");
    const tagPremium = $("tagPremium");

    const goLogin = $("goLogin");
    const goPremium = $("goPremium");
    const logoutBtn = $("logoutBtn");

    const statusMsg = $("statusMsg");

    const lockedBox = $("lockedBox");
    const appBox = $("appBox");

    const btnLogin = $("btnLogin");
    const btnPremium = $("btnPremium");
    const btnHome = $("btnHome");
    const btnForceHome = $("btnForceHome");

    const question = $("question");
    const years = $("years");
    const limit = $("limit");
    const askBtn = $("askBtn");
    const clearBtn = $("clearBtn");
    const msg = $("msg");

    const aiSwitch = $("aiSwitch");
    let aiEnabled = false;

    const tabs = $("tabs");
    const loading = $("loading");
    const answerBox = $("answerBox");
    const officialBox = $("officialBox");
    const pubmedBox = $("pubmedBox");
    const refsRow = $("refsRow");
    const copyRefs = $("copyRefs");
    const copyLinks = $("copyLinks");

    const copyPix = $("copyPix");
    const sendWhatsapp = $("sendWhatsapp");
    const pixPayload = $("pixPayload");

    function isPremiumValue(v){
      if (v === true) return true;
      if (typeof v === "string") return ["true","1","yes","sim"].includes(v.trim().toLowerCase());
      if (typeof v === "number") return v === 1;
      return false;
    }

    function setTopUser(label, state, isPremium){
      userName.textContent = label;
      userState.textContent = state;

      const ch = (label || "?").trim().slice(0,1).toUpperCase();
      avatar.textContent = ch || "?";

      if (isPremium === true) {
        tagPremium.textContent = "premium";
        tagPremium.className = "tag ok";
      } else if (isPremium === false) {
        tagPremium.textContent = "free";
        tagPremium.className = "tag bad";
      } else {
        tagPremium.textContent = "—";
        tagPremium.className = "tag";
      }
    }

    function setStatus(text, type="warn"){
      statusMsg.className = "msg show " + type;
      statusMsg.textContent = text;
    }
    function hideStatus(){
      statusMsg.className = "msg";
      statusMsg.textContent = "";
    }

    function setMsg(text, type="warn"){
      msg.className = "msg show " + type;
      msg.textContent = text;
    }
    function clearMsg(){
      msg.className = "msg";
      msg.textContent = "";
    }

    // =========================
    // ✅ MENU: anti-trava “tela escura”
    // =========================
    function openMenu(open){
      userMenu.classList.toggle("open", !!open);
      userBtn.setAttribute("aria-expanded", String(!!open));
      backdrop.classList.toggle("open", !!open);
      backdrop.setAttribute("aria-hidden", String(!open));
    }

    function forceCloseMenu(){
      userMenu.classList.remove("open");
      userBtn.setAttribute("aria-expanded", "false");
      backdrop.classList.remove("open");
      backdrop.setAttribute("aria-hidden", "true");
    }

    userBtn.addEventListener("click", () => {
      const isOpen = userMenu.classList.contains("open");
      openMenu(!isOpen);
    });

    backdrop.addEventListener("click", forceCloseMenu);

    document.addEventListener("scroll", () => forceCloseMenu(), { passive:true });

    document.addEventListener("click", (e) => {
      if (!userMenu.contains(e.target) && !userBtn.contains(e.target)) forceCloseMenu();
    });

    // ✅ iPhone/Android: volta/retoma página (bfcache) pode deixar backdrop preso
    window.addEventListener("pageshow", forceCloseMenu);
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") forceCloseMenu();
    });

    goLogin.addEventListener("click", () => window.location.href = SITE_BASE + "login.html?mode=login");
    goPremium.addEventListener("click", () => window.location.href = SITE_BASE + "premium.html?go=perguntas.html");

    logoutBtn.addEventListener("click", async () => {
      try{ await supabase.auth.signOut(); }catch(e){}
      window.location.href = SITE_BASE + "index.html";
    });

    btnLogin?.addEventListener("click", () => window.location.href = SITE_BASE + "login.html?mode=login");
    btnPremium?.addEventListener("click", () => window.location.href = SITE_BASE + "premium.html?go=perguntas.html");
    btnHome?.addEventListener("click", () => window.location.href = SITE_BASE + "index.html");

    btnForceHome?.addEventListener("click", () => {
      AUTO_HOME_IF_NOT_PREMIUM = true;
      setStatus("Redirecionamento automático ativado ✅ (logou sem Premium → vai para o Início).", "ok");
    });

    aiSwitch.addEventListener("click", () => toggleAI());
    aiSwitch.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleAI(); }
    });

    function toggleAI(){
      aiEnabled = !aiEnabled;
      aiSwitch.classList.toggle("on", aiEnabled);
      aiSwitch.setAttribute("aria-checked", String(aiEnabled));
    }

    function setLoading(on){
      loading.style.display = on ? "" : "none";
      if (on){
        tabs.style.display = "none";
        refsRow.style.display = "none";
        answerBox.style.display = "none";
        officialBox.style.display = "none";
        pubmedBox.style.display = "none";
      }
    }

    function esc(s){
      return String(s||"").replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[m]));
    }

    function setTab(name){
      document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab === name));
      answerBox.style.display = (name === "answer") ? "" : "none";
      officialBox.style.display = (name === "official") ? "" : "none";
      pubmedBox.style.display = (name === "pubmed") ? "" : "none";
    }

    function wireTabs(){
      document.querySelectorAll(".tab").forEach(btn => {
        btn.onclick = () => setTab(btn.dataset.tab);
      });
    }
    wireTabs();

    clearBtn.addEventListener("click", () => {
      question.value = "";
      clearMsg();
      tabs.style.display = "none";
      refsRow.style.display = "none";
      answerBox.style.display = "none";
      officialBox.style.display = "none";
      pubmedBox.style.display = "none";
      answerBox.innerHTML = "";
      officialBox.innerHTML = "";
      pubmedBox.innerHTML = "";
      question.focus();
    });

    copyPix.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(pixPayload.value.trim());
        setStatus("Pix copiado ✅ Cole no app do banco e faça o pagamento.", "ok");
      }catch{
        setStatus("Não consegui copiar automaticamente. Selecione o Pix e copie manualmente.", "warn");
      }
    });

    sendWhatsapp.addEventListener("click", async () => {
      const { data } = await supabase.auth.getUser();
      const email = data?.user?.email || "(sem login)";
      const text = encodeURIComponent(
        WHATSAPP_DEFAULT_TEXT + email +
        "\n\nChave Pix: 28d39758-0fe0-47f1-9c7c-9cb6e032c5cf\nValor: R$ 2,00\nReferência: PREMIUM-LPP"
      );
      window.open(`https://wa.me/${WHATSAPP_PHONE}?text=${text}`, "_blank");
    });

    let lastCitations = [];
    let lastLinks = [];

    copyRefs.addEventListener("click", async () => {
      try{
        const refs = lastCitations.map((c,i) => `${i+1}. ${c.title} — ${c.source}. ${c.url}`).join("\n");
        await navigator.clipboard.writeText(refs);
        setMsg("Referências copiadas ✅", "ok");
      }catch{
        setMsg("Não consegui copiar automaticamente.", "warn");
      }
    });

    copyLinks.addEventListener("click", async () => {
      try{
        const links = lastLinks.join("\n");
        await navigator.clipboard.writeText(links);
        setMsg("Links copiados ✅", "ok");
      }catch{
        setMsg("Não consegui copiar automaticamente.", "warn");
      }
    });

    async function ask(){
      clearMsg();
      const q = question.value.trim();
      if (!q) return setMsg("Digite uma pergunta.", "bad");

      setLoading(true);

      try{
        const url = new URL(ASK_API_BASE.replace(/\/$/,"") + "/ask");
        url.searchParams.set("q", q);
        url.searchParams.set("limit", limit.value);
        url.searchParams.set("years", years.value);
        url.searchParams.set("ai", aiEnabled ? "1" : "0");

        // ✅ Supabase Functions: enviar apikey/Authorization (funciona mesmo se verify_jwt=false)
        const r = await fetch(url.toString(), {
          method:"GET",
          headers: {
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": "Bearer " + SUPABASE_ANON_KEY
          }
        });

        let data = {};
        try { data = await r.json(); } catch { data = { error: "Resposta inválida do servidor." }; }

        if (!r.ok) {
          setLoading(false);
          return setMsg("Falha na busca:\n" + (data?.error || "erro desconhecido"), "bad");
        }

        lastCitations = Array.isArray(data.citations) ? data.citations : [];
        lastLinks = lastCitations.map(c => c.url).filter(Boolean);

        answerBox.innerHTML = `
          <div class="result">
            <h3>Resposta</h3>
            <p>${esc(data.answer || "Sem resposta sintetizada. Consulte as fontes abaixo.")}</p>
            <div class="mini">
              <span class="chip">Domínios: ${(data.domains_used || []).slice(0,8).map(esc).join(", ") || "—"}</span>
              <span class="chip">${esc(data.generated_at || "")}</span>
            </div>
          </div>
        `;

        const web = Array.isArray(data.web) ? data.web : [];
        officialBox.innerHTML = !web.length ? `
          <div class="result">
            <h3>Fontes oficiais</h3>
            <p>Nenhum resultado oficial retornou (ou provedor de busca não configurado).</p>
          </div>
        ` : web.map(x => `
          <div class="result">
            <h3>${esc(x.title || "Sem título")}</h3>
            <p>${esc(x.snippet || "")}</p>
            <div class="mini">
              <span class="chip">${esc(x.source || "")}</span>
              <a href="${esc(x.url || "#")}" target="_blank" rel="noopener noreferrer">${esc(x.url || "")}</a>
            </div>
          </div>
        `).join("");

        const pm = Array.isArray(data.pubmed) ? data.pubmed : [];
        pubmedBox.innerHTML = !pm.length ? `
          <div class="result">
            <h3>PubMed</h3>
            <p>Nenhum artigo encontrado com a janela selecionada.</p>
          </div>
        ` : pm.map(x => `
          <div class="result">
            <h3>${esc(x.title || "Sem título")}</h3>
            <p>${esc(x.journal || "")}${x.year ? " • " + esc(x.year) : ""}${x.doi ? " • DOI: " + esc(x.doi) : ""}</p>
            <div class="mini">
              <span class="chip">PMID: ${esc(x.pmid || "")}</span>
              <a href="${esc(x.url || "#")}" target="_blank" rel="noopener noreferrer">${esc(x.url || "")}</a>
            </div>
          </div>
        `).join("");

        setLoading(false);
        tabs.style.display = "";
        refsRow.style.display = (lastCitations.length ? "" : "none");
        setTab("answer");
        setMsg("Busca concluída ✅", "ok");

      } catch (e) {
        setLoading(false);
        setMsg("Erro inesperado:\n" + String(e), "bad");
      }
    }

    askBtn.addEventListener("click", ask);
    question.addEventListener("keydown", (e) => { if (e.key === "Enter") ask(); });

    // ✅ Tenta garantir linha em profiles (evita “sou premium mas não libera” por falta de linha)
    async function ensureProfileRow(user){
      try{
        await supabase.from("profiles").upsert({
          id: user.id,
          email: user.email || null,
          updated_at: new Date().toISOString()
        });
      }catch(_e){
        // se RLS bloquear upsert, não quebra o app; o erro real aparece no select.
      }
    }

    async function gate(){
      hideStatus();
      setTopUser("Visitante", "Checando sessão…", null);
      lockedBox.style.display = "";
      appBox.style.display = "none";

      // ✅ Anti “carregando infinito” (aumentado para celular)
      let timedOut = false;
      const hardTimer = setTimeout(() => {
        timedOut = true;
        setTopUser("Visitante", "Verificação lenta…", null);
        setStatus(
          "A verificação está demorando.\n\nPossíveis causas:\n- cache antigo do site (service worker)\n- RLS/policy bloqueando leitura da tabela profiles\n\nToque em Login/Premium e volte.",
          "warn"
        );
      }, 8000);

      // ✅ Primeiro: session (mais rápido). Depois: user.
      const { data: sRes } = await supabase.auth.getSession();
      const session = sRes?.session;

      if (!session){
        clearTimeout(hardTimer);
        if (!timedOut){
          setTopUser("Visitante", "Não logado", null);
          userMeta.textContent = "Acesso: visitante";
          setStatus("Faça login para acessar (Premium).", "warn");
        }
        return;
      }

      const { data: userRes, error: userErr } = await supabase.auth.getUser();

      if (userErr || !userRes?.user){
        clearTimeout(hardTimer);
        setTopUser("Visitante", "Sessão inválida", null);
        userMeta.textContent = "Sessão indisponível";
        setStatus("Erro ao verificar login. Abra Login e tente novamente.", "bad");
        return;
      }

      const email = userRes.user.email || "Usuário";
      userMeta.textContent = "E-mail: " + email;

      setTopUser(email, "Checando Premium…", null);

      // ✅ garante linha do perfil (se não existir)
      await ensureProfileRow(userRes.user);

      // ✅ Premium check (robusto)
      const uid = userRes.user.id;
      const { data: prof, error: profErr } = await supabase
        .from("profiles")
        .select("premium")
        .eq("id", uid)
        .single();

      clearTimeout(hardTimer);

      if (profErr){
        setTopUser(email, "Falha ao ler profiles", null);
        lockedBox.style.display = "";
        appBox.style.display = "none";
        setStatus(
          "Não consegui ler a tabela profiles.\n\nErro: " + profErr.message +
          "\n\nCausas comuns:\n- RLS sem policy SELECT para profiles\n- linha do usuário não existe (upsert bloqueado)\n\nAjuste no Supabase e toque em “Premium” para testar.",
          "bad"
        );
        return;
      }

      const premiumOk = isPremiumValue(prof?.premium);

      if (premiumOk){
        setTopUser(email, "Premium ativo ✅", true);
        lockedBox.style.display = "none";
        appBox.style.display = "";
        setStatus("Premium ativo. Você pode perguntar.", "ok");
        return;
      }

      setTopUser(email, "Sem Premium", false);
      lockedBox.style.display = "";
      appBox.style.display = "none";
      setStatus("Você está logado, mas sem Premium. Pague via Pix e envie comprovante.", "warn");

      if (AUTO_HOME_IF_NOT_PREMIUM){
        window.location.replace(SITE_BASE + "index.html");
      }
    }

    supabase.auth.onAuthStateChange(() => gate());
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") gate();
    });

    gate();
  </script>
</body>
</html>