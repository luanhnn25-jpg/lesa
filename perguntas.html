<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b3d91" />
  <title>Perguntas • Fontes Oficiais + PubMed • LPP</title>

  <style>
    :root{
      --bg1:#0b3d91; --bg2:#0a2f73; --bg3:#0b5bd3;
      --page:#eef2f7; --card:#ffffff; --text:#0f172a;
      --muted:#475569; --muted2:#64748b;
      --border:rgba(15,23,42,.10);
      --shadow:0 12px 30px rgba(2,6,23,.10);
      --shadow2:0 18px 45px rgba(2,6,23,.14);
      --radius:18px;
      --ring:0 0 0 4px rgba(56,130,246,.18);
      --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;
      --chip:#eef2ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(11,91,211,.15), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(11,61,145,.14), transparent 55%),
        var(--page);
    }
    header{
      background:linear-gradient(180deg,var(--bg1), #0b4ab1);
      color:#fff;
      padding:18px 14px 16px;
      position:sticky;
      top:0;
      z-index:50;
      box-shadow:0 12px 24px rgba(2,6,23,.14);
    }
    .top{
      max-width:980px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      min-width:0;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.18);
      display:grid; place-items:center;
      font-weight:1000; letter-spacing:.5px;
      flex:0 0 auto;
    }
    .brandTxt{min-width:0}
    .brand h1{
      margin:0;
      font-size:18px;
      font-weight:1000;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .brand p{
      margin:4px 0 0;
      opacity:.92;
      font-size:12px;
      line-height:1.25;
    }
    .statusPill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 10px 18px rgba(2,6,23,.16);
      color:#fff;
      font-weight:950;
      user-select:none;
      white-space:nowrap;
    }
    .statusDot{
      width:30px;height:30px;border-radius:999px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.20);
      border:1px solid rgba(255,255,255,.18);
      font-weight:1000;
    }
    main{
      max-width:980px;
      margin:18px auto 60px;
      padding:0 14px;
    }
    .card{
      background:linear-gradient(180deg,#fff, rgba(255,255,255,.98));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin:14px 0;
    }
    .title{
      display:flex; align-items:center; gap:10px;
      margin:0 0 10px;
      font-size:18px;
      font-weight:1000;
      color:#0b2b63;
      letter-spacing:.2px;
    }
    .title::before{
      content:"";
      width:4px; height:20px; border-radius:999px;
      background:var(--bg3);
      box-shadow:0 10px 18px rgba(11,91,211,.25);
    }
    .muted{color:var(--muted); line-height:1.55; margin:0}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 820px){ .grid{grid-template-columns:1fr} }
    label{
      display:block;
      font-size:12px;
      color:var(--muted2);
      font-weight:900;
      margin:10px 0 6px;
    }
    .field, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      outline:none;
      font-size:14px;
      transition: box-shadow .14s ease, border-color .14s ease;
    }
    .field:focus, select:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: var(--ring);
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 520px){ .row2{grid-template-columns:1fr} }
    .toggleBox{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      margin-top:10px;
    }
    .toggleBox .t1{font-weight:1000; color:#0b2b63}
    .toggleBox .t2{font-size:12px; color:var(--muted); margin-top:4px; line-height:1.35}
    .switch{
      position:relative;
      width:52px; height:30px;
      border-radius:999px;
      background:#e5e7eb;
      border:1px solid rgba(15,23,42,.12);
      cursor:pointer;
      flex:0 0 auto;
    }
    .switch::after{
      content:"";
      position:absolute;
      top:50%; left:4px;
      width:22px; height:22px;
      border-radius:999px;
      transform:translateY(-50%);
      background:#fff;
      box-shadow:0 10px 18px rgba(2,6,23,.14);
      transition: left .16s ease;
    }
    .switch.on{background: rgba(37,99,235,.25); border-color: rgba(37,99,235,.25)}
    .switch.on::after{left:26px}
    .btnRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 520px){ .btnRow{grid-template-columns:1fr} }
    button{
      border:none;
      border-radius:14px;
      padding:12px 12px;
      font-weight:1000;
      cursor:pointer;
      font-size:14px;
      transition: transform .05s ease, filter .15s ease;
    }
    button:active{transform:translateY(1px)}
    .btnPrimary{
      background:linear-gradient(180deg,#2563eb,#1d4ed8);
      color:#fff;
      box-shadow:0 16px 30px rgba(2,6,23,.12);
    }
    .btnGhost{
      background:#fff;
      border:1px solid rgba(37,99,235,.25);
      color:#1d4ed8;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .chip{
      border:1px solid rgba(15,23,42,.10);
      background:var(--chip);
      color:#0b2b63;
      border-radius:999px;
      padding:8px 10px;
      font-weight:950;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .tabs{
      display:flex;
      gap:8px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .tab{
      flex:1 1 180px;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:1000;
      color:var(--muted);
      text-align:center;
    }
    .tab[aria-selected="true"]{
      border-color: rgba(37,99,235,.35);
      background: rgba(37,99,235,.08);
      color:#1d4ed8;
    }
    .panel{display:none; margin-top:12px}
    .panel.show{display:block}
    .box{
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      border-radius:16px;
      padding:12px;
      box-shadow:0 14px 26px rgba(2,6,23,.07);
    }
    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      color:var(--muted);
      font-size:13px;
      white-space:pre-wrap;
    }
    .msg.ok{border-color:rgba(22,163,74,.30); background:rgba(22,163,74,.08); color:#14532d}
    .msg.warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); color:#7c2d12}
    .msg.bad{border-color:rgba(220,38,38,.30); background:rgba(220,38,38,.08); color:#7f1d1d}
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .item{
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px;
      padding:12px;
      background:#fff;
      box-shadow:0 12px 22px rgba(2,6,23,.06);
    }
    .item h3{margin:0 0 6px; font-size:14px; color:#0b2b63}
    .item p{margin:0; color:var(--muted); font-size:13px; line-height:1.45}
    .item a{color:#1d4ed8; font-weight:950; text-decoration:none}
    .item a:hover{text-decoration:underline}
    footer{
      text-align:center;
      color:#64748b;
      font-size:13px;
      padding:18px 10px 30px;
    }
  </style>
</head>

<body>
  <header>
    <div class="top">
      <div class="brand">
        <div class="logo">LPP</div>
        <div class="brandTxt">
          <h1>Perguntas com Fontes Oficiais</h1>
          <p>gov.br • COREN-SP • OMS/OPAS • PubMed</p>
        </div>
      </div>

      <div class="statusPill" title="Acesso livre">
        <div class="statusDot">V</div>
        <div>
          <div style="font-weight:1000; line-height:1.05;">Visitante</div>
          <div style="opacity:.9; font-size:12px; font-weight:900;">Acesso livre</div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <h2 class="title">Perguntar</h2>
      <p class="muted">
        Acesso livre. Você pode pesquisar e ver as fontes (oficiais e PubMed) sem login.
      </p>

      <label for="q">Pergunta</label>
      <input id="q" class="field" type="text" placeholder="Ex.: Como prevenir lesão por pressão em pacientes acamados?" />

      <div class="row2">
        <div>
          <label for="years">Janela (anos)</label>
          <select id="years">
            <option value="3">Últimos 3 anos</option>
            <option value="5" selected>Últimos 5 anos</option>
            <option value="10">Últimos 10 anos</option>
            <option value="20">Últimos 20 anos</option>
          </select>
        </div>

        <div>
          <label for="limit">Resultados</label>
          <select id="limit">
            <option value="4">4</option>
            <option value="6" selected>6</option>
            <option value="8">8</option>
            <option value="10">10</option>
          </select>
        </div>
      </div>

      <div class="toggleBox">
        <div>
          <div class="t1">Modo IA (síntese)</div>
          <div class="t2">Se ativado, a função retorna um texto de síntese (baseado nos títulos do PubMed).</div>
        </div>
        <div id="aiSwitch" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
      </div>

      <div class="btnRow">
        <button id="btnAsk" class="btnPrimary" type="button">Buscar</button>
        <button id="btnClear" class="btnGhost" type="button">Limpar</button>
      </div>

      <div class="chips">
        <span class="chip" data-q="lesão por pressão prevenção">lesão por pressão • prevenção</span>
        <span class="chip" data-q="pressure injury staging">pressure injury • staging</span>
        <span class="chip" data-q="vacina deltoide agulha calibre">vacina • agulha • deltoide</span>
      </div>

      <div class="tabs" role="tablist" aria-label="Resultados">
        <button class="tab" id="tabAnswer" type="button" role="tab" aria-selected="true">Resposta</button>
        <button class="tab" id="tabWeb" type="button" role="tab" aria-selected="false">Fontes oficiais</button>
        <button class="tab" id="tabPubmed" type="button" role="tab" aria-selected="false">PubMed</button>
      </div>

      <div id="panelAnswer" class="panel show" role="tabpanel">
        <div class="box">
          <div id="answerBox" class="muted">Digite uma pergunta e clique em <b>Buscar</b>.</div>
          <div id="msg" class="msg warn" style="display:none"></div>
        </div>
      </div>

      <div id="panelWeb" class="panel" role="tabpanel">
        <div class="box">
          <p class="muted" style="margin:0">
            Nesta versão pública, a aba “Fontes oficiais” pode ficar vazia se o backend ainda não estiver implementando web/gov.br.
          </p>
          <div id="webList" class="list"></div>
        </div>
      </div>

      <div id="panelPubmed" class="panel" role="tabpanel">
        <div class="box">
          <div id="pubmedList" class="list"></div>
        </div>
      </div>
    </section>
  </main>

  <footer>© 2026 • Projeto Integrador</footer>

  <script>
    // ✅ endpoint público da sua Edge Function (depois do deploy com --no-verify-jwt)
    const FUNCTION_URL = "https://owpswekkfaleauwjmahc.supabase.co/functions/v1/ask";

    const el = (id) => document.getElementById(id);

    const qEl = el("q");
    const yearsEl = el("years");
    const limitEl = el("limit");

    const btnAsk = el("btnAsk");
    const btnClear = el("btnClear");

    const tabAnswer = el("tabAnswer");
    const tabWeb = el("tabWeb");
    const tabPubmed = el("tabPubmed");

    const panelAnswer = el("panelAnswer");
    const panelWeb = el("panelWeb");
    const panelPubmed = el("panelPubmed");

    const answerBox = el("answerBox");
    const pubmedList = el("pubmedList");
    const webList = el("webList");
    const msg = el("msg");

    const aiSwitch = el("aiSwitch");
    let ai = 0;

    function setMsg(text, type="warn"){
      msg.style.display = "block";
      msg.className = "msg " + type;
      msg.textContent = text;
    }
    function clearMsg(){
      msg.style.display = "none";
      msg.textContent = "";
      msg.className = "msg";
    }

    function setTab(which){
      const map = {
        answer: [tabAnswer, panelAnswer],
        web:    [tabWeb, panelWeb],
        pubmed: [tabPubmed, panelPubmed],
      };

      Object.entries(map).forEach(([k, [t, p]]) => {
        const on = k === which;
        t.setAttribute("aria-selected", String(on));
        p.classList.toggle("show", on);
      });
    }

    tabAnswer.addEventListener("click", () => setTab("answer"));
    tabWeb.addEventListener("click", () => setTab("web"));
    tabPubmed.addEventListener("click", () => setTab("pubmed"));

    // Switch IA
    function setAi(next){
      ai = next ? 1 : 0;
      aiSwitch.classList.toggle("on", !!ai);
      aiSwitch.setAttribute("aria-checked", String(!!ai));
    }
    aiSwitch.addEventListener("click", () => setAi(!ai));
    aiSwitch.addEventListener("keydown", (e) => {
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        setAi(!ai);
      }
    });

    // Chips
    document.querySelectorAll(".chip[data-q]").forEach(ch => {
      ch.addEventListener("click", () => {
        qEl.value = ch.getAttribute("data-q") || "";
        qEl.focus();
      });
    });

    function escapeHtml(str){
      return String(str ?? "").replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[m]));
    }

    function renderWeb(items){
      webList.innerHTML = "";
      if(!Array.isArray(items) || items.length === 0){
        webList.innerHTML = `<div class="item"><h3>Sem resultados</h3><p>Nenhuma fonte oficial retornada pelo backend.</p></div>`;
        return;
      }
      items.forEach((it) => {
        const title = escapeHtml(it?.title || "Fonte");
        const url = escapeHtml(it?.url || "#");
        const source = escapeHtml(it?.source || "");
        webList.insertAdjacentHTML("beforeend", `
          <div class="item">
            <h3>${title}</h3>
            <p>${source ? source + " • " : ""}<a href="${url}" target="_blank" rel="noopener">Abrir</a></p>
          </div>
        `);
      });
    }

    function renderPubmed(items){
      pubmedList.innerHTML = "";
      if(!Array.isArray(items) || items.length === 0){
        pubmedList.innerHTML = `<div class="item"><h3>Sem resultados</h3><p>Tente outras palavras-chave ou aumente a janela de anos.</p></div>`;
        return;
      }
      items.forEach((it) => {
        const title = escapeHtml(it?.title || "Sem título");
        const journal = escapeHtml(it?.journal || "");
        const year = it?.year ? ` • ${escapeHtml(it.year)}` : "";
        const pmid = escapeHtml(it?.pmid || "");
        const url = escapeHtml(it?.url || (pmid ? `https://pubmed.ncbi.nlm.nih.gov/${pmid}/` : "#"));
        const doi = escapeHtml(it?.doi || "");
        pubmedList.insertAdjacentHTML("beforeend", `
          <div class="item">
            <h3>${title}</h3>
            <p>${journal}${year}${doi ? " • DOI: " + doi : ""}</p>
            <p><a href="${url}" target="_blank" rel="noopener">Abrir no PubMed</a></p>
          </div>
        `);
      });
    }

    async function ask(){
      clearMsg();
      const q = (qEl.value || "").trim();
      const years = Number(yearsEl.value || 5);
      const limit = Number(limitEl.value || 6);

      if(!q){
        setMsg("Digite uma pergunta antes de buscar.", "bad");
        setTab("answer");
        return;
      }

      btnAsk.disabled = true;
      btnAsk.textContent = "Buscando…";
      answerBox.textContent = "Consultando…";

      try{
        const url = new URL(FUNCTION_URL);
        url.searchParams.set("q", q);
        url.searchParams.set("years", String(years));
        url.searchParams.set("limit", String(limit));
        url.searchParams.set("ai", String(ai));

        // ✅ SEM Authorization, SEM apikey
        const res = await fetch(url.toString(), { method:"GET", cache:"no-store" });

        if(!res.ok){
          const txt = await res.text().catch(() => "");
          throw new Error(`Erro HTTP ${res.status}\n${txt}`);
        }

        const data = await res.json();

        // Resposta
        const answer = data?.answer || "Consulta concluída. Veja a aba PubMed para os resultados.";
        answerBox.textContent = answer;

        // Web / PubMed
        renderWeb(data?.web || data?.citations || []);
        renderPubmed(data?.pubmed || []);

        setMsg("Busca concluída ✅", "ok");
        setTab("answer");

      }catch(err){
        answerBox.textContent = "Não foi possível obter a resposta.";
        setMsg(String(err?.message || err), "bad");
        setTab("answer");
      }finally{
        btnAsk.disabled = false;
        btnAsk.textContent = "Buscar";
      }
    }

    btnAsk.addEventListener("click", ask);

    btnClear.addEventListener("click", () => {
      qEl.value = "";
      answerBox.innerHTML = 'Digite uma pergunta e clique em <b>Buscar</b>.';
      pubmedList.innerHTML = "";
      webList.innerHTML = "";
      clearMsg();
      setTab("answer");
      qEl.focus();
    });

    // Enter para buscar
    qEl.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        ask();
      }
    });

    // estado inicial
    setAi(false);
    setTab("answer");
  </script>
</body>
</html>
