<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0a0a0b" />
  <title>Pesquisa Oficial • Brasil</title>

  <style>
    :root{
      --bg:#0a0a0b;
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.44);
      --shadow: 0 24px 80px rgba(0,0,0,.60);
      --shadow2: 0 18px 45px rgba(0,0,0,.45);
      --radius:18px;
      --ring: 0 0 0 4px rgba(255,255,255,.10);
      --ring2: 0 0 0 3px rgba(255,255,255,.08);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 50% -10%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(900px 520px at 10% 20%, rgba(255,255,255,.04), transparent 55%),
        var(--bg);
      letter-spacing:.2px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    header{
      position:sticky; top:0; z-index:60;
      background: rgba(10,10,11,.72);
      backdrop-filter: blur(14px);
      border-bottom:1px solid var(--stroke);
    }
    .top{
      max-width:1000px;
      margin:0 auto;
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:0;}
    .logo{
      width:42px; height:42px;
      border-radius:14px;
      display:grid; place-items:center;
      background:#fff; color:#000;
      font-weight:950;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      user-select:none;
      flex:0 0 auto;
    }
    .brandText{min-width:0}
    .brandText h1{
      margin:0;
      font-size:14px;
      font-weight:950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:62vw;
    }
    .brandText p{
      margin:4px 0 0;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:62vw;
    }
    .right{display:flex; align-items:center; gap:10px;}
    .pill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-weight:850;
      font-size:12px;
      white-space:nowrap;
      user-select:none;
    }
    .kbd{
      font-family:var(--mono);
      font-size:11px;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.70);
      user-select:none;
      display:none;
    }
    @media(min-width:860px){ .kbd{display:inline-flex} }

    main{
      max-width:1000px;
      margin:18px auto 80px;
      padding:0 14px;
    }
    .card{
      border-radius: var(--radius);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:18px 16px 12px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .title{margin:0; font-size:16px; font-weight:950;}
    .sub{
      margin:10px 0 0;
      color:var(--muted);
      font-weight:700;
      line-height:1.55;
      font-size:13px;
    }
    .content{padding:16px;}

    .searchWrap{display:flex; flex-direction:column; gap:12px;}
    .search{
      display:flex; align-items:center; gap:10px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow2);
      transition: border-color .15s ease, box-shadow .15s ease, transform .08s ease;
    }
    .search:focus-within{
      border-color: rgba(255,255,255,.20);
      box-shadow: var(--shadow2), var(--ring);
      transform: translateY(-1px);
    }
    .icon{
      width:40px; height:40px;
      border-radius:14px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      color:#fff;
      font-weight:950;
      user-select:none;
      flex:0 0 auto;
    }
    input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:15px;
      font-weight:850;
      letter-spacing:.2px;
    }
    input::placeholder{ color: rgba(255,255,255,.48); font-weight:750; }

    .chips{display:flex; gap:8px; flex-wrap:wrap;}
    .chip{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.78);
      font-weight:850;
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      transition: filter .15s ease, transform .06s ease, border-color .15s ease;
      user-select:none;
    }
    .chip:hover{ filter: brightness(1.10); border-color: rgba(255,255,255,.16); }
    .chip:active{ transform: translateY(1px); }

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    button{
      border:none;
      border-radius:14px;
      padding:12px 14px;
      font-weight:950;
      letter-spacing:.2px;
      cursor:pointer;
      transition: transform .06s ease, filter .15s ease, box-shadow .15s ease, opacity .15s ease;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--text);
    }
    button:hover{ filter: brightness(1.10); }
    button:active{ transform: translateY(1px); }
    button:focus-visible{ outline:none; box-shadow: var(--ring2); }
    button[disabled]{ opacity:.55; cursor:not-allowed; transform:none; }
    .primary{ background:#fff; color:#000; border:none; box-shadow: 0 14px 30px rgba(255,255,255,.08); }
    .mini{ padding:10px 12px; border-radius:12px; font-size:12px; font-weight:900; }

    /* controles de qualidade */
    .opts{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.02);
      border-radius:16px;
      padding:10px 12px;
      box-shadow: 0 12px 28px rgba(0,0,0,.25);
    }
    .opt{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }
    .opt label{
      font-size:12px;
      font-weight:900;
      color: rgba(255,255,255,.78);
      user-select:none;
      white-space:nowrap;
    }
    select{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.90);
      font-weight:900;
      border-radius:12px;
      padding:8px 10px;
      outline:none;
      cursor:pointer;
    }
    select:focus-visible{ box-shadow: var(--ring2); }
    .smallNote{
      color: rgba(255,255,255,.55);
      font-weight:850;
      font-size:12px;
      margin-left:auto;
      white-space:nowrap;
    }
    @media(max-width:860px){
      .smallNote{ width:100%; margin-left:0; }
    }

    .split{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:12px;
      margin-top:14px;
    }
    @media(max-width:860px){ .split{grid-template-columns:1fr} }

    .box{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      overflow:hidden;
    }
    .boxHead{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px;
      border-bottom:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
    }
    .boxHead h3{
      margin:0;
      font-size:12px;
      font-weight:950;
      color: rgba(255,255,255,.72);
      letter-spacing:.25px;
      text-transform: uppercase;
    }
    .boxBody{padding:12px;}

    /* Chat */
    .chat{display:flex; flex-direction:column; gap:10px; max-height:52vh; overflow:auto; padding-right:4px;}
    .bubble{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 12px 28px rgba(0,0,0,.30);
      white-space:pre-wrap;
      word-break:break-word;
      line-height:1.65;
      font-weight:780;
      font-size:13.2px;
    }
    .bubble.user{ margin-left:14%; background: rgba(255,255,255,.03); }
    .bubble.assistant{ margin-right:10%; }
    .bHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px;}
    .role{font-size:11px; font-weight:950; letter-spacing:.25px; text-transform:uppercase; color: rgba(255,255,255,.72);}
    .stamp{font-family: var(--mono); font-size:11px; font-weight:900; color: rgba(255,255,255,.45); flex:0 0 auto;}
    .typing{opacity:.85; font-weight:850; color: rgba(255,255,255,.78);}

    .metaLine{
      margin-top:10px;
      color: var(--muted2);
      font-weight:800;
      font-size:12px;
      display:none;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .dot{width:5px;height:5px;border-radius:99px;background: rgba(255,255,255,.22); display:inline-block;}

    details{border-top:1px solid var(--stroke); background: rgba(255,255,255,.02);}
    summary{
      list-style:none;
      cursor:pointer;
      padding:12px;
      font-weight:950;
      color: rgba(255,255,255,.86);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    summary::-webkit-details-marker{display:none}
    .caret{
      width:10px;height:10px;
      border-right:2px solid rgba(255,255,255,.55);
      border-bottom:2px solid rgba(255,255,255,.55);
      transform: rotate(45deg);
      transition: transform .15s ease;
      flex:0 0 auto;
    }
    details[open] .caret{ transform: rotate(225deg); }

    .list{ display:flex; flex-direction:column; gap:10px; padding:0 12px 12px; }
    .item{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.02);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 12px 28px rgba(0,0,0,.30);
    }
    .item strong{
      display:block;
      font-size:12px;
      font-weight:950;
      color: rgba(255,255,255,.80);
      margin-bottom:6px;
    }
    .item .t{
      color: rgba(255,255,255,.70);
      font-weight:800;
      font-size:12.5px;
      line-height:1.45;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .item a{
      display:block;
      margin-top:10px;
      color: rgba(255,255,255,.92);
      text-decoration:none;
      font-weight:900;
      word-break:break-word;
      font-size:12px;
    }
    .item a:hover{ text-decoration: underline; }

    .history{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      overflow:hidden;
    }
    .historyHead{
      padding:12px;
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(255,255,255,.03);
    }
    .historyHead h3{
      margin:0;
      font-size:12px;
      font-weight:950;
      color: rgba(255,255,255,.72);
      letter-spacing:.25px;
      text-transform: uppercase;
    }
    .historyList{display:flex; flex-direction:column; gap:8px; padding:12px;}
    .hItem{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding:10px;
      cursor:pointer;
      transition: filter .15s ease, transform .06s ease, border-color .15s ease;
      user-select:none;
    }
    .hItem:hover{ filter: brightness(1.08); border-color: rgba(255,255,255,.14); }
    .hItem:active{ transform: translateY(1px); }
    .hText{
      color: rgba(255,255,255,.78);
      font-weight:850;
      font-size:12.5px;
      line-height:1.35;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .hTime{
      color: rgba(255,255,255,.42);
      font-weight:900;
      font-size:11px;
      font-family: var(--mono);
      flex:0 0 auto;
      margin-left:8px;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      max-width: 92vw;
      width: 520px;
      background: rgba(20,20,22,.82);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{
      opacity:1;
      pointer-events:auto;
      transform: translateX(-50%) translateY(-2px);
    }
    .toastText{
      font-weight:900;
      font-size:12.5px;
      color: rgba(255,255,255,.86);
      line-height:1.35;
    }
    .toastText small{
      display:block;
      margin-top:3px;
      color: rgba(255,255,255,.55);
      font-weight:800;
      font-size:11px;
    }
    .toastBtn{
      padding:9px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.86);
      font-weight:950;
      cursor:pointer;
      user-select:none;
    }

    footer{text-align:center; color: var(--muted2); font-weight:800; font-size:12px; padding:18px 10px 30px;}
    @media (prefers-reduced-motion: reduce){ *{ animation:none !important; transition:none !important; } }
  </style>
</head>

<body>
  <header>
    <div class="top">
      <div class="brand">
        <div class="logo">PI</div>
        <div class="brandText">
          <h1>Pesquisa Oficial • Brasil</h1>
          <p>MS/ANVISA (gov.br) • COFEN • COREN-SP • OPAS/PAHO • OMS/WHO</p>
        </div>
      </div>
      <div class="right">
        <span class="kbd">Ctrl K</span>
        <div class="pill" id="verPill">Modo IA</div>
      </div>
    </div>
  </header>

  <main>
    <section class="card" aria-label="Pesquisa">
      <div class="cardHead">
        <h2 class="title">Pergunte e receba uma resposta com fontes oficiais</h2>
        <p class="sub">
          A resposta é organizada em linguagem técnico-científica e lista as <b>fontes oficiais</b> utilizadas.
          Use <b>Baixar PDF</b> para gerar um relatório (Imprimir → Salvar como PDF).
        </p>
      </div>

      <div class="content">
        <div class="searchWrap">
          <div class="search" role="search">
            <div class="icon" aria-hidden="true">⌕</div>
            <input id="q" type="text" autocomplete="off"
              placeholder="Ex.: Quais condutas de enfermagem na administração segura de medicamentos?"
              aria-label="Digite sua pergunta" />
          </div>

          <!-- NOVO: controles de “resposta grande” -->
          <div class="opts" aria-label="Configurações da resposta">
            <div class="opt">
              <label for="detailSel">Detalhamento</label>
              <select id="detailSel" aria-label="Nível de detalhamento">
                <option value="standard">Padrão</option>
                <option value="full" selected>Completa</option>
                <option value="max">Máxima</option>
              </select>
            </div>

            <div class="opt">
              <label for="refsSel">Fontes no texto</label>
              <select id="refsSel" aria-label="Modo de referências">
                <option value="end" selected>Ao final</option>
                <option value="inline">No corpo + final</option>
              </select>
            </div>

            <div class="smallNote" id="lenNote">Pronto para respostas longas.</div>
          </div>

          <div class="chips" aria-label="Sugestões">
            <button class="chip" type="button" data-q="O que é SAE e quais são as etapas do Processo de Enfermagem?">SAE / Processo</button>
            <button class="chip" type="button" data-q="Quais medidas de segurança do paciente são recomendadas na assistência hospitalar?">Segurança do paciente</button>
            <button class="chip" type="button" data-q="Como registrar e documentar cuidados de enfermagem de forma adequada (aspectos ético-legais)?">Registros</button>
            <button class="chip" type="button" data-q="Quais condutas de enfermagem na administração segura de medicamentos e prevenção de erros?">Medicamentos</button>
          </div>

          <div class="row">
            <button id="btnAsk" class="primary" type="button">Pesquisar</button>
            <button id="btnStop" type="button" title="Cancelar requisição em andamento" disabled>Parar</button>
            <button id="btnCopy" type="button">Copiar resposta</button>
            <button id="btnCopyAll" type="button">Copiar com fontes</button>
            <button id="btnPdf" type="button">Baixar PDF</button>
            <button id="btnShare" type="button">Compartilhar</button>
            <button id="btnClear" type="button">Limpar</button>
          </div>
        </div>

        <div class="split">
          <div class="box">
            <div class="boxHead">
              <h3>Resposta</h3>
              <div class="row" style="gap:8px">
                <button id="btnRetry" class="mini" type="button" title="Repetir busca">Repetir</button>
              </div>
            </div>

            <div class="boxBody">
              <div id="chatBox" class="chat" aria-label="Conversa">
                <div class="bubble assistant">
                  <div class="bHead">
                    <span class="role">Assistente</span>
                    <span class="stamp" id="helloStamp"></span>
                  </div>
                  Digite uma pergunta e clique em <b>Pesquisar</b>.
                </div>
              </div>

              <div class="metaLine" id="metaLine">
                <span id="metaTime"></span>
                <span class="dot" aria-hidden="true"></span>
                <span id="metaSources"></span>
              </div>
            </div>

            <details id="sourcesDetails">
              <summary>
                Fontes utilizadas
                <span class="caret" aria-hidden="true"></span>
              </summary>
              <div id="webList" class="list"></div>
            </details>
          </div>

          <div>
            <div class="history" aria-label="Histórico">
              <div class="historyHead">
                <h3>Histórico</h3>
                <button id="btnClearHist" class="mini" type="button">Limpar</button>
              </div>
              <div id="historyList" class="historyList"></div>
            </div>

            <div style="margin-top:12px; padding:12px; border:1px solid var(--stroke); border-radius:18px; background:rgba(255,255,255,.02)">
              <div style="font-weight:950; font-size:12px; color:rgba(255,255,255,.72); letter-spacing:.25px; text-transform:uppercase">
                Dica rápida
              </div>
              <div style="margin-top:10px; color:rgba(255,255,255,.70); font-weight:800; font-size:12.8px; line-height:1.55">
                Para respostas mais fortes, inclua: população, cenário, intervenção/conduta, objetivo (ex.: “em UTI adulto”, “na APS”, “em gestantes”, “em pós-operatório”).
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <footer>© 2026 • Projeto Integrador</footer>

  <div id="toast" class="toast" role="status" aria-live="polite">
    <div class="toastText" id="toastText">OK<small id="toastSub">...</small></div>
    <button class="toastBtn" id="toastBtn" type="button">Fechar</button>
  </div>

<script>
  // ============================
  // CONFIG
  // ============================
  const PROJECT_REF = "owpswekkfaleauwjmahc";
  const FUNCTION_URL = `https://${PROJECT_REF}.supabase.co/functions/v1/ask`;

  // Se sua Function exigir autorização, use a ANON key do Supabase (pública) aqui.
  // const SUPABASE_ANON_KEY = "COLE_SUA_ANON_KEY_SE_PRECISAR";
  // const AUTH_HEADERS = SUPABASE_ANON_KEY ? { "Authorization": `Bearer ${SUPABASE_ANON_KEY}` } : {};
  const AUTH_HEADERS = {};

  // Instruções do lado do cliente (enviadas como contexto; o backend pode ignorar sem quebrar)
  const SYSTEM_INSTRUCTIONS = `
Você é um assistente técnico-científico em enfermagem e saúde pública.
Responda em português do Brasil, com linguagem formal científica, estruturada, aprofundada e aplicável à prática clínica.
Priorize órgãos e organizações oficiais: Ministério da Saúde e ANVISA (gov.br), COFEN/COREN, OPAS/PAHO e OMS/WHO.
Se a evidência não sustentar uma afirmação, declare a limitação. Não invente portarias, resoluções ou números.
Entregue uma resposta completa, com recomendações práticas e seção de referências oficiais.
`.trim();

  // ============================
  // Helpers
  // ============================
  const el = (id) => document.getElementById(id);

  const qEl = el("q");
  const chatBox = el("chatBox");
  const webList = el("webList");
  const verPill = el("verPill");
  const metaLine = el("metaLine");
  const metaTime = el("metaTime");
  const metaSources = el("metaSources");
  const sourcesDetails = el("sourcesDetails");
  const lenNote = el("lenNote");

  const detailSel = el("detailSel");
  const refsSel = el("refsSel");

  const btnAsk = el("btnAsk");
  const btnStop = el("btnStop");

  const toast = el("toast");
  const toastText = el("toastText");
  const toastSub = el("toastSub");
  const toastBtn = el("toastBtn");

  const historyList = el("historyList");

  let lastPayload = null;
  let lastQuestion = "";
  let toastTimer = null;
  let inFlight = null; // AbortController

  const HISTORY_KEY = "pi_history_v4";
  const HISTORY_MAX = 12;

  function escapeHtml(str){
    return String(str ?? "").replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
    }[m]));
  }
  function nowStamp(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }

  function showToast(title, sub=""){
    clearTimeout(toastTimer);
    toastText.firstChild.nodeValue = title;
    toastSub.textContent = sub || "";
    toast.classList.add("show");
    toastTimer = setTimeout(() => toast.classList.remove("show"), 2800);
  }
  toastBtn.addEventListener("click", () => toast.classList.remove("show"));

  function normalizePayload(data){
    return {
      version: data?.version ?? data?.model ?? "",
      answer: data?.answer ?? data?.text ?? data?.output ?? "",
      sources: data?.sources ?? data?.web ?? data?.citations ?? data?.references ?? [],
      cached: !!data?.cached,
    };
  }

  function renderWeb(items){
    webList.innerHTML = "";
    if(!Array.isArray(items) || items.length === 0){
      webList.innerHTML = `
        <div class="item">
          <strong>Sem fontes retornadas</strong>
          <div class="t">Tente reformular a pergunta com termos mais específicos (população, cenário, conduta, objetivo).</div>
        </div>`;
      return;
    }
    items.forEach((it) => {
      const title = escapeHtml(it?.title || it?.name || "Referência");
      const org = escapeHtml(it?.org || it?.source || it?.publisher || "Fonte oficial");
      const url = escapeHtml(it?.url || it?.link || "#");
      webList.insertAdjacentHTML("beforeend", `
        <div class="item">
          <strong>${org}</strong>
          <div class="t">${title}</div>
          <a href="${url}" target="_blank" rel="noopener">${url}</a>
        </div>
      `);
    });
  }

  function setMeta(norm){
    const now = new Date();
    metaTime.textContent = `Atualizado: ${now.toLocaleString("pt-BR")}${norm.cached ? " • cache" : ""}`;
    metaSources.textContent = `${(norm.sources?.length ?? 0)} fonte(s) listada(s)`;
    metaLine.style.display = "flex";

    const answerLen = (norm.answer || "").length;
    lenNote.textContent = answerLen ? `Resposta: ${answerLen.toLocaleString("pt-BR")} caracteres.` : "Pronto para respostas longas.";
  }

  function addBubble(role, text, opts={}){
    const stamp = opts.stamp ?? nowStamp();
    const safe = (opts.html === true) ? text : escapeHtml(text);

    const div = document.createElement("div");
    div.className = `bubble ${role}`;
    div.innerHTML = `
      <div class="bHead">
        <span class="role">${role === "user" ? "Usuário" : "Assistente"}</span>
        <span class="stamp">${escapeHtml(stamp)}</span>
      </div>
      <div class="${opts.typing ? "typing" : ""}">${safe}</div>
    `;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
    return div;
  }

  function replaceBubbleText(bubble, text){
    const inner = bubble?.querySelector("div:last-child");
    if(!inner) return;
    inner.classList.remove("typing");
    inner.textContent = text ?? "";
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function saveHistory(q){
    const raw = localStorage.getItem(HISTORY_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    const item = { q, t: Date.now() };
    const filtered = arr.filter(x => x?.q !== q);
    filtered.unshift(item);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(filtered.slice(0, HISTORY_MAX)));
    renderHistory();
  }

  function renderHistory(){
    const raw = localStorage.getItem(HISTORY_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    historyList.innerHTML = "";

    if(!arr.length){
      historyList.innerHTML = `
        <div style="color:rgba(255,255,255,.55); font-weight:850; font-size:12.8px; line-height:1.55">
          Sem histórico ainda. Faça uma pergunta para salvar aqui.
        </div>`;
      return;
    }

    arr.forEach((x) => {
      const dt = new Date(x.t);
      const hh = String(dt.getHours()).padStart(2,"0");
      const mm = String(dt.getMinutes()).padStart(2,"0");
      const t = `${hh}:${mm}`;
      historyList.insertAdjacentHTML("beforeend", `
        <div class="hItem" tabindex="0" role="button" aria-label="Repetir pergunta">
          <div class="hText">${escapeHtml(x.q)}</div>
          <div class="hTime">${t}</div>
        </div>
      `);
    });

    [...historyList.querySelectorAll(".hItem")].forEach((node, idx) => {
      const q = arr[idx].q;
      node.addEventListener("click", () => { qEl.value = q; ask(); });
      node.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          qEl.value = q;
          ask();
        }
      });
    });
  }

  function getLastAssistantText(){
    const bubbles = [...chatBox.querySelectorAll(".bubble.assistant")];
    if(!bubbles.length) return "";
    const last = bubbles[bubbles.length - 1];
    const inner = last.querySelector("div:last-child");
    return inner ? inner.innerText.trim() : "";
  }

  function buildRefsText(payload){
    const norm = normalizePayload(payload || {});
    const refs = Array.isArray(norm.sources) ? norm.sources : [];
    if(!refs.length) return "";
    const lines = refs.map((r, i) => {
      const org = r?.org || r?.source || r?.publisher || "Fonte oficial";
      const title = r?.title || r?.name || "Referência";
      const url = r?.url || r?.link || "";
      return `${i+1}. ${org} — ${title}\n${url}`.trim();
    });
    return lines.join("\n\n");
  }

  function buildReportHtml(){
    const q = (qEl.value || "").trim();
    const when = new Date().toLocaleString("pt-BR");
    const norm = normalizePayload(lastPayload || {});
    const version = norm?.version ? String(norm.version) : "";
    const answer = norm?.answer ? String(norm.answer) : "";
    const refs = norm?.sources || [];

    const refsHtml = (Array.isArray(refs) ? refs : []).map(r => {
      const org = escapeHtml(r?.org || r?.source || r?.publisher || "Fonte oficial");
      const url = escapeHtml(r?.url || r?.link || "");
      const title = escapeHtml(r?.title || r?.name || "");
      return `<li><b>${org}</b><br>${title}<br><span style="word-break:break-word">${url}</span></li>`;
    }).join("");

    return `
      <html>
      <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1"/>
        <title>Relatório • Projeto Integrador</title>
        <style>
          body{font-family:Arial, sans-serif; padding:24px; color:#111}
          h1{margin:0 0 6px; font-size:18px}
          .muted{color:#555; font-size:12px; margin:0 0 16px}
          .box{border:1px solid #ddd; border-radius:12px; padding:14px; margin-top:14px}
          pre{white-space:pre-wrap; line-height:1.6; margin:0}
          ul{margin:10px 0 0; padding-left:18px}
          li{margin:0 0 10px}
        </style>
      </head>
      <body>
        <h1>Relatório de Pesquisa • Projeto Integrador</h1>
        <p class="muted">Gerado em: ${escapeHtml(when)} ${version ? " • Versão: " + escapeHtml(version) : ""}</p>

        <div class="box"><b>Pergunta</b><pre>${escapeHtml(q)}</pre></div>
        <div class="box"><b>Resposta</b><pre>${escapeHtml(answer)}</pre></div>

        <div class="box">
          <b>Fontes utilizadas (oficiais)</b>
          <ul>${refsHtml || "<li>Sem fontes.</li>"}</ul>
        </div>

        <p class="muted" style="margin-top:18px">Observação: verifique data/versão e escopo das publicações oficiais.</p>

        <script>setTimeout(() => window.print(), 350);<\/script>
      </body>
      </html>
    `;
  }

  function setBusy(isBusy){
    btnAsk.disabled = isBusy;
    btnStop.disabled = !isBusy;
    qEl.disabled = isBusy;
    detailSel.disabled = isBusy;
    refsSel.disabled = isBusy;
  }

  function mapDetailToHints(detail){
    // Esses “hints” podem ser ignorados pelo backend sem quebrar.
    // Se o backend suportar, você já tem o controle pronto no front.
    if(detail === "max") return { maxOutputTokensHint: 2400, depth: "max", sections: "extended" };
    if(detail === "full") return { maxOutputTokensHint: 1800, depth: "full", sections: "standard" };
    return { maxOutputTokensHint: 1100, depth: "standard", sections: "standard" };
  }

  async function ask(){
    const q = (qEl.value || "").trim();
    if(!q){
      showToast("Digite uma pergunta", "Ex.: “Quais condutas de enfermagem…?”");
      qEl.focus();
      return;
    }

    // aborta requisição anterior se existir
    if(inFlight){
      try{ inFlight.abort(); }catch{}
      inFlight = null;
    }

    lastQuestion = q;

    addBubble("user", q);
    const typingBubble = addBubble("assistant", "Consultando fontes oficiais e elaborando resposta completa…", { typing:true });

    renderWeb([]);
    sourcesDetails.open = true;
    metaLine.style.display = "none";
    setBusy(true);

    const controller = new AbortController();
    inFlight = controller;

    const detail = detailSel.value || "full";
    const refsMode = refsSel.value || "end";
    const hints = mapDetailToHints(detail);

    try{
      const res = await fetch(FUNCTION_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json", ...AUTH_HEADERS },
        body: JSON.stringify({
          question: q,

          // compatível mesmo se o backend ignorar
          system: SYSTEM_INSTRUCTIONS,
          locale: "pt-BR",

          // NOVO: “hints” para respostas grandes
          detailLevel: detail,             // standard | full | max
          referencesMode: refsMode,        // end | inline
          maxOutputTokensHint: hints.maxOutputTokensHint,
          depth: hints.depth,
          sections: hints.sections,
        }),
        cache: "no-store",
        signal: controller.signal,
      });

      if(!res.ok){
        const t = await res.text().catch(()=> "");
        throw new Error(`HTTP ${res.status}\n${t}`);
      }

      const data = await res.json();
      lastPayload = data;

      const norm = normalizePayload(data);
      verPill.textContent = norm.version ? `Modo IA • ${norm.version}` : "Modo IA";

      replaceBubbleText(typingBubble, norm.answer || "Consulta concluída.");
      renderWeb(norm.sources);
      setMeta(norm);

      saveHistory(q);
      showToast("Busca concluída", "Resposta e fontes atualizadas.");
    }catch(err){
      const msg = (err?.name === "AbortError")
        ? "Requisição cancelada."
        : String(err?.message || err);

      replaceBubbleText(
        typingBubble,
        err?.name === "AbortError"
          ? "Requisição cancelada."
          : "Não foi possível obter a resposta. Veja detalhes em “Fontes utilizadas”."
      );

      webList.innerHTML = `
        <div class="item">
          <strong>${err?.name === "AbortError" ? "Cancelado" : "Falha na consulta"}</strong>
          <div class="t">${escapeHtml(msg)}</div>
        </div>`;
      showToast(err?.name === "AbortError" ? "Cancelado" : "Erro", "Veja a mensagem em ‘Fontes utilizadas’.");
    }finally{
      if(inFlight === controller) inFlight = null;
      setBusy(false);
    }
  }

  function stop(){
    if(inFlight){
      try{ inFlight.abort(); }catch{}
      inFlight = null;
      showToast("Parando…", "Cancelando requisição em andamento.");
      setBusy(false);
    }
  }

  async function copyAnswer(){
    const text = getLastAssistantText();
    if(!text){
      showToast("Nada para copiar", "Faça uma pesquisa primeiro.");
      return;
    }
    try{
      await navigator.clipboard.writeText(text);
      showToast("Copiado ✅", "Última resposta copiada.");
    }catch{
      showToast("Não foi possível copiar", "Seu navegador bloqueou a área de transferência.");
    }
  }

  async function copyAnswerWithSources(){
    const ans = getLastAssistantText();
    if(!ans){
      showToast("Nada para copiar", "Faça uma pesquisa primeiro.");
      return;
    }
    const refs = buildRefsText(lastPayload);
    const pack = refs
      ? `${ans}\n\nReferências (fontes oficiais)\n\n${refs}`
      : ans;

    try{
      await navigator.clipboard.writeText(pack);
      showToast("Copiado ✅", refs ? "Resposta + fontes copiadas." : "Resposta copiada.");
    }catch{
      showToast("Não foi possível copiar", "Seu navegador bloqueou a área de transferência.");
    }
  }

  function downloadPdf(){
    if(!lastPayload){
      showToast("Faça uma pesquisa antes", "Depois gere o relatório em PDF.");
      return;
    }
    const html = buildReportHtml();
    const w = window.open("", "_blank");
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  async function share(){
    const base = new URL(window.location.href);
    base.searchParams.set("q", qEl.value || "");
    try{
      await navigator.clipboard.writeText(base.toString());
      showToast("Link copiado ✅", "Envie para compartilhar a pergunta.");
    }catch{
      showToast("Falha ao copiar link", "Copie manualmente na barra do navegador.");
    }
  }

  el("btnAsk").addEventListener("click", ask);
  el("btnStop").addEventListener("click", stop);

  el("btnRetry").addEventListener("click", () => {
    if(lastQuestion){ qEl.value = lastQuestion; ask(); }
    else showToast("Nada para repetir", "Faça uma pesquisa primeiro.");
  });
  el("btnPdf").addEventListener("click", downloadPdf);
  el("btnShare").addEventListener("click", share);
  el("btnCopy").addEventListener("click", copyAnswer);
  el("btnCopyAll").addEventListener("click", copyAnswerWithSources);

  el("btnClear").addEventListener("click", () => {
    stop();
    qEl.value = "";
    chatBox.innerHTML = `
      <div class="bubble assistant">
        <div class="bHead">
          <span class="role">Assistente</span>
          <span class="stamp">${escapeHtml(nowStamp())}</span>
        </div>
        Digite uma pergunta e clique em <b>Pesquisar</b>.
      </div>
    `;
    webList.innerHTML = "";
    lastPayload = null;
    lastQuestion = "";
    verPill.textContent = "Modo IA";
    metaLine.style.display = "none";
    sourcesDetails.open = false;
    lenNote.textContent = "Pronto para respostas longas.";
    showToast("Limpo", "Campo e resultados zerados.");
    qEl.focus();
  });

  el("btnClearHist").addEventListener("click", () => {
    localStorage.removeItem(HISTORY_KEY);
    renderHistory();
    showToast("Histórico limpo", "As últimas perguntas foram apagadas.");
  });

  document.querySelectorAll(".chip").forEach(btn => {
    btn.addEventListener("click", () => {
      qEl.value = btn.getAttribute("data-q") || "";
      ask();
    });
  });

  qEl.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){ e.preventDefault(); ask(); }
    if(e.key === "Escape"){ stop(); }
  });

  window.addEventListener("keydown", (e) => {
    if((e.ctrlKey || e.metaKey) && (e.key.toLowerCase() === "k")){
      e.preventDefault();
      qEl.focus();
    }
    if(e.key === "Escape"){ stop(); }
  });

  (function init(){
    const helloStamp = el("helloStamp");
    if(helloStamp) helloStamp.textContent = nowStamp();

    renderHistory();
    const u = new URL(window.location.href);
    const q = u.searchParams.get("q");
    if(q){
      qEl.value = q;
      setTimeout(ask, 120);
    }else{
      qEl.focus();
    }
  })();
</script>
</body>
</html>
